<%- include("partials/_header",{title:"user profile"}) %>
  
    <div class="card bg-secondary-subtle">
        <div class="card-header bg-transparent border-bottom border-3 border-primary">
            <h2 class="card-title"><%= userProfile.name %></h2>
        </div>
        <div class="card-body">
            <div class="d-lg-flex justify-content-between">
                <div class="">
                    <div class="card-text">
                        <span class="fw-bold">Email : </span>
                        <%= userProfile.email %>
                    </div>
                    <% if(userProfile.page_link){ %>
                        <div class="card-text">
                            <span class="fw-bold">Page Link : </span>
                            <a href="<%= userProfile.page_link %>" target="_blank" ><%= userProfile.page_link %></a>
                        </div>
                    <% } %>
                    <% if(userProfile.repository_link){ %>
                        <div class="card-text">
                            <span class="fw-bold">Repository Link : </span>
                            <a href="<%= userProfile.repository_link %>" target="_blank" ><%= userProfile.repository_link %></a>
                        </div>
                    <% } %>
    
                    <% if(userProfile.id == user.id || user.role == "admin"){ %>
                        <div class="d-flex gap-3 my-3">
                        <div><a class="btn btn-primary fw-bold" href="/users/edit/<%=userProfile.id%>">Edit</a></div>
                        <% if(userProfile.role == "deleted"){ %>
                            <p class="text-warning">Account deleted</p>
                        <% }else{ %>
                            <form action="/users/delete/<%=userProfile.id%>" method="POST" onclick="return confirm('Are you sure you want to delete your account?')">
                              <input type="submit" class="btn btn-danger fw-bold" value="Delete Account">
                            </form>
                        <% } %>
                        </div>
                    <% } %>
                </div>
                <div class="my-2">
                    <img src="<%= userProfile.avatar %>" alt="user avatar" class="border border-1 border-primary" width="200px">
                    <div>
                        <span class="text-muted"><% if (userProfile.role=="student") { %>
                            Student
                            <% }else if(userProfile.role=="admin"){ %>
                            Admin
                            <% }else if(userProfile.role=="teacher") { %>
                            Teacher
                            <% } else { %>
                            Deleted
                            <% } %>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h4>Courses</h4>
    <div id="courseContainer">
        <div class="loading-spinner">Loading courses...</div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const courseContainer = document.getElementById("courseContainer");
        
        async function getCourses() {
            try {
                const response = await fetch("/courses", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    cache: "no-cache"
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                renderCourses(data);
                
            } catch (error) {
                console.error("Error fetching courses:", error);
                courseContainer.innerHTML = `
                    <div class="error-message">
                        <p>Failed to load courses. Please try again later.</p>
                    </div>
                `;
            }
        }

        function renderCourses(courses) {
            courseContainer.innerHTML = "";

            if (!courses || courses.length === 0) {
                courseContainer.innerHTML = `
                    <div class="no-courses">
                        <p>No courses found.</p>
                    </div>
                `;
                return;
            }

            courses.forEach((course) => {
                const courseDiv = document.createElement("div");
                courseDiv.className = "course-card";
                courseDiv.innerHTML = `
                    <div class="course-header">
                        <h5>${escapeHtml(course.title)}</h5>
                        <div class="course-actions">
                            <button class="edit-button" data-id="${course.id}">Edit</button>
                            <button class="delete-button" data-id="${course.id}">Delete</button>
                        </div>
                    </div>
                    <div class="course-body">
                        <p class="course-description">${escapeHtml(course.description)}</p>
                        <div class="course-details">
                            <span class="detail"><strong>Duration:</strong> ${escapeHtml(course.course_duration)}</span>
                            <span class="detail"><strong>Fee:</strong> ${escapeHtml(course.course_fee)}</span>
                            <span class="detail status-${course.status.toLowerCase()}"><strong>Status:</strong> ${escapeHtml(course.status)}</span>
                        </div>
                    </div>
                `;
                courseContainer.appendChild(courseDiv);
            });

            // Add event listeners to buttons
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
            
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', handleEdit);
            });
        }

        // Basic HTML escaping to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function handleDelete(e) {
            const courseId = e.target.getAttribute('data-id');
            console.log('Delete course', courseId);
            // Implement delete functionality
        }

        function handleEdit(e) {
            const courseId = e.target.getAttribute('data-id');
            console.log('Edit course', courseId);
            // Implement edit functionality
        }

        // Initial load
        getCourses();
    });
</script>
    
       
<%- include("partials/_footer") %>